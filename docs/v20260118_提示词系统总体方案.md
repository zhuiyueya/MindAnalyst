# 提示词系统总体方案（全链路/多任务/多版本）

## 1. 背景
当前提示词主要集中在单视频总结（`video_summary/v1|v2`）与作者报告、RAG 相关场景。随着需求扩展，需要一个**系统级的提示词架构**，支持：
- 不同任务（摘要/报告/检索问答/重排/分类/清洗等）
- 不同内容类型（观点、科普、教程、新闻、访谈）
- 多版本快速切换与回滚
- UI 稳定展示（统一 normalized）

## 2. 目标
1. **类型可选路由**：优先使用用户在前端选择的 `content_type`，未选择时再用分类器识别。
2. **版本化配置**：版本切换只改配置，不改代码。
3. **稳定的归一化输出**：raw 与 normalized 分层，UI 只读 normalized。
4. **可扩展与可评测**：支持 A/B 测试与评测集回归。

## 3. 核心设计

### 3.1 任务类型（task_type）
建议建立统一的任务类型枚举，用于路由与 schema 管理：
- `summary.single`：单内容结构化摘要（视频/文章）
- `summary.short`：短摘要（50-200 字）
- `report.author`：作者级报告
- `rag.answer`：问答回答
- `rag.rerank`：重排
- `content.classify`：内容类型识别
- `content.clean`：文本清洗/规范化（可选）

### 3.2 内容类型（content_type）
建议默认范围：`insight / howto / science / news / story / generic`。
优先由用户在前端选择；未选择时再触发分类器。

### 3.3 Prompt Profile Registry
统一注册入口，分为 **通用 Prompts（分类/清洗/兜底）** 与 **类型覆盖 Prompts（每种类型的核心任务）**，路由策略：
1) summary/report/rag 等**必须走类型覆盖**。
2) 仅 content.classify / content.clean 等走 common。

```yaml
# src/prompts/profiles.yaml
profiles:
  common:
    content.classify: { key: "common/content_classify/v1" }
    content.clean: { key: "common/content_clean/v1" }

  overrides:
    insight:
      summary.single: { key: "types/insight/summary_single/v2" }
      summary.short:  { key: "types/insight/summary_short/v1" }
      report.author:  { key: "types/insight/author_report/v1" }
      rag.answer:     { key: "types/insight/rag/answer_v1" }
      rag.rerank:     { key: "types/insight/rag/rerank_v1" }
    howto:
      summary.single: { key: "types/howto/summary_single/v1" }
      summary.short:  { key: "types/howto/summary_short/v1" }
      report.author:  { key: "types/howto/author_report/v1" }
      rag.answer:     { key: "types/howto/rag/answer_v1" }
      rag.rerank:     { key: "types/howto/rag/rerank_v1" }
    science:
      summary.single: { key: "types/science/summary_single/v1" }
      summary.short:  { key: "types/science/summary_short/v1" }
      report.author:  { key: "types/science/author_report/v1" }
      rag.answer:     { key: "types/science/rag/answer_v1" }
      rag.rerank:     { key: "types/science/rag/rerank_v1" }
    news:
      summary.single: { key: "types/news/summary_single/v1" }
      summary.short:  { key: "types/news/summary_short/v1" }
      report.author:  { key: "types/news/author_report/v1" }
      rag.answer:     { key: "types/news/rag/answer_v1" }
      rag.rerank:     { key: "types/news/rag/rerank_v1" }
    story:
      summary.single: { key: "types/story/summary_single/v1" }
      summary.short:  { key: "types/story/summary_short/v1" }
      report.author:  { key: "types/story/author_report/v1" }
      rag.answer:     { key: "types/story/rag/answer_v1" }
      rag.rerank:     { key: "types/story/rag/rerank_v1" }
    generic:
      summary.single: { key: "types/generic/summary_single/v1" }
      summary.short:  { key: "types/generic/summary_short/v1" }
      report.author:  { key: "types/generic/author_report/v1" }
      rag.answer:     { key: "types/generic/rag/answer_v1" }
      rag.rerank:     { key: "types/generic/rag/rerank_v1" }
```

特点：
- summary/report/rag 对每个类型独立维护，保证风格与结构一致。
- common 只服务分类/清洗/兜底，避免类型稀释。
- 版本升级只改 `profiles.yaml`。

### 3.4 Prompt 模板目录结构
```
src/prompts/templates/
  common/
    content_classify/v1.yaml
    content_clean/v1.yaml
  types/
    insight/
      summary_single/v2.yaml
      summary_short/v1.yaml
      author_report/v1.yaml
      rag/answer_v1.yaml
      rag/rerank_v1.yaml
    howto/
      summary_single/v1.yaml
      summary_short/v1.yaml
      author_report/v1.yaml
      rag/answer_v1.yaml
      rag/rerank_v1.yaml
    science/
      summary_single/v1.yaml
      summary_short/v1.yaml
      author_report/v1.yaml
      rag/answer_v1.yaml
      rag/rerank_v1.yaml
    news/
      summary_single/v1.yaml
      summary_short/v1.yaml
      author_report/v1.yaml
      rag/answer_v1.yaml
      rag/rerank_v1.yaml
    story/
      summary_single/v1.yaml
      summary_short/v1.yaml
      author_report/v1.yaml
      rag/answer_v1.yaml
      rag/rerank_v1.yaml
    generic/
      summary_single/v1.yaml
      summary_short/v1.yaml
      author_report/v1.yaml
      rag/answer_v1.yaml
      rag/rerank_v1.yaml
```

### 3.5 Schema 与归一化策略
**每个 task_type 都有一个 BaseNormalized**，并允许扩展字段：

- `summary.single`（基础结构）
```json
{
  "one_liner": "",
  "key_points": [],
  "summary": "",
  "facts": [],
  "content_type": "insight",
  "profile": "summary/insight/v2",
  "extensions": {}
}
```

- `summary.short`
```json
{ "short_summary": "", "bullets": [] }
```

- `report.author`
```json
{ "core_philosophy": "", "main_topics": [], "evolution": "", "report_markdown": "" }
```

- `rag.answer`
```json
{ "answer": "", "citations": [] }
```

**raw 输出永久保留**，normalized 统一供 UI 使用：
```json
{
  "raw": { ... },
  "normalized": { ... }
}
```

### 3.6 内容类型与作者类型规则
1) **作者类型（author_type）**：仅由用户指定（不自动识别）。
2) 若作者类型已指定，作者名下所有内容 **继承该类型**，不再做内容类型识别。
3) 若作者类型未指定：
   - 用户选择的内容类型优先；
   - 未选择则调用分类器为每篇内容判定类型。
4) 允许内容级别的手动修正，记录来源（user/classifier/author_inherit）。

### 3.7 Prompt Router（选择策略）
1) 根据上面的规则确定 `content_type`。
2) `task_type` 必须明确。
3) summary/report/rag 一律从 `overrides.<content_type>` 取。
4) 若该类型缺失，则回退到 `overrides.generic`；仅分类/清洗任务走 `common`。
5) 可基于 **策略规则**（作者、平台、时长）二次定制。


## 4. 数据与 UI 约定
### 4.1 数据模型（新增/调整）
- **ContentItem**：新增 `content_type`、`content_type_source`（user/classifier/author_inherit）。
- **Author**：新增 `author_type`（可空，仅用户指定）、`author_type_source`（user）。
- **AuthorReport**（建议新增表）：
  - `author_id`
  - `content_type`
  - `report_type`（默认 report.author）
  - `json_data`（raw + normalized）
  - `content_ids` / `content_count`（可选，用于溯源）

### 4.2 UI 约定
- DB 保存结构：`Summary.json_data = {raw, normalized}`
- `Summary.content` 统一取 `normalized.summary`（或短摘要）
- UI 只读 normalized 的稳定字段
- extensions 用于分区展示（可折叠）

## 5. 运行流程
**内容级任务（summary/rag）**
1) 任务触发 → 确定 task_type
2) 决定 content_type：作者类型优先，否则用户选择，再否则分类器
3) Prompt Router 选 profile（类型覆盖优先）
4) LLM 输出 raw → Normalizer 输出 normalized → 入库

**作者报告（手动触发）**
1) 用户在前端点击“生成作者类型报告”
2) 若作者类型已指定：直接用该类型生成单份报告
3) 若作者类型未指定：按作者内容的 content_type 分组
4) 对每个分组生成一份 `AuthorReport(author_id, content_type)`

## 6. 实施步骤建议
**Phase 1（基础）**
- 建立 `profiles.yaml`
- LLMService 增加 Router + Normalizer 注册表
- summary.single 完成 content_type 分流

**Phase 2（扩展）**
- 新增 content.classify（自动识别类型）
- 批量评测与 A/B 试验

**Phase 3（系统化）**
- Prompt 质量监控（失败率/空话率）
- 评测集与回归报告

## 7. 风险与注意事项
- 类型错误会导致选错 prompt → 必须保留人工修正
- 新增字段必须先进入 `extensions`，再逐步 UI 支持
- 不同任务 normalized schema 必须稳定，避免破坏旧数据

---

此方案覆盖全提示词体系（总结/报告/问答/重排/分类等），实现多任务、多类型、多版本的系统化管理与可扩展性。
