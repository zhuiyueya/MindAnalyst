# Mind-Analyst 方案文档（技术方案/架构）

## 1. 概述
本方案面向个人工具 Mind-Analyst：
- 离线构建（Build）：导入作者 → 抓取/转写/分段 → 摘要与作者报告 → 入库
- 在线服务（Serve）：Chat 问答 → 分层检索（混合检索+重排）→ 证据拼装（带时间戳）→ 生成回答与引用校验

设计目标：
- 支持作者内容规模达到“数千条”
- 增量更新、断点续跑、失败重试、可观测
- 产出可追溯引用（视频时间戳/文章段落定位）
- 可扩展到多平台（B 站→公众号→更多）

## 2. 总体架构
### 2.1 模块划分
- **Web/UI**：作者导入、任务进度、报告浏览、Chat 问答、引用回跳
- **API 服务**：鉴权（可选/个人工具可先无）、任务创建、检索与回答
- **Task Queue & Workers**：
  - Ingestion Worker：采集作者内容列表、元信息
  - Transcribe Worker：字幕获取/ASR 转写
  - Segment Worker：分段、清洗、语言检测
  - Index Worker：embedding、写入检索索引
  - Summarize Worker：单内容结构化摘要
  - Synthesis Worker：跨内容聚类与作者级报告
- **Storage**：
  - 结构化库（Postgres）
  - 向量检索（优先 pgvector；后续可替换 Milvus/Qdrant 等）
  - 对象存储（可选：原始字幕/音频；个人工具可先本地磁盘）

### 2.2 两条主链路
- **Build（离线构建）**：
  1) AuthorImportJob → 2) ContentSyncJob → 3) TranscribeJob → 4) SegmentJob → 5) IndexJob → 6) SummarizeJob → 7) AuthorSynthesisJob
- **Serve（在线问答）**：
  1) Query Parse → 2) Query Expansion → 3) Level-1 Retrieval（内容级）→ 4) Level-2 Retrieval（段落级）→ 5) Rerank → 6) Context Assemble（邻近补全/去重/压缩）→ 7) Answer Generate（带引用）→ 8) Grounding Check

### 2.3 技术选型（FastAPI + LangChain，本地启动优先）
本节给出一套“默认推荐”的本地可启动技术栈，并列出可替换项，便于你后续按成本/性能继续演进。

#### 2.3.1 后端与 API
- **Web 框架**：FastAPI
- **ASGI Server**：uvicorn
- **数据校验/配置**：Pydantic v2、pydantic-settings（读取 `.env`）
- **HTTP 客户端**：httpx（采集/调用外部 API）

#### 2.3.2 LLM/Embedding/Rerank（硅基流动 + LangChain）
- **LLM 供应商**：硅基流动（SiliconFlow）
  - 若硅基流动提供 **OpenAI 兼容接口**：优先用 LangChain 的 OpenAI 兼容 ChatModel（只需配置 `base_url` 与 `api_key`）。
  - 若不是完全兼容：封装一个自定义 LangChain ChatModel/LLM Wrapper（将“请求/流式返回”适配到 LangChain）。
- **Embedding**（向量化）建议：优先选中文表现稳定的通用 embedding（例如 BGE 系列/同类模型），并保证“入库与查询”使用同一模型。
- **Rerank**（重排）建议：优先选 cross-encoder reranker（例如 BGE reranker 系列/同类模型），用于将候选段落做二次排序。

#### 2.3.3 LangChain 生态建议
- **编排**：LangChain（Chains / Runnables）
- **Agent/多跳检索**：优先考虑 LangGraph（更适合状态机/可观测/可回放）
- **向量库适配**：优先用 LangChain 的 PGVector 适配层（对接 pgvector）

#### 2.3.4 数据库与检索（本地一体化优先）
- **结构化库**：PostgreSQL
- **向量检索**：pgvector（同库完成结构化 + 向量检索）
- **关键词检索**：Postgres FTS（`tsvector` + `ts_rank`）
- **混合检索融合**：应用层做 RRF（Reciprocal Rank Fusion）或加权融合，将“关键词召回 + 向量召回”合并后再交给 rerank。

#### 2.3.5 后台任务队列与调度
- **任务队列（推荐）**：Celery + Redis
  - 适合：大量离线任务（采集/ASR/embedding/摘要）的断点续跑、失败重试、限速。
- **定时调度**：Celery Beat（或 APScheduler 作为替代）
- **可替换项**：RQ / Dramatiq（更轻量，但生态与特性取舍不同）

#### 2.3.6 爬取与内容抽取
- **B 站采集**：优先使用成熟的 B 站 Python SDK/封装库（例如 bilibili-api-python 这类），减少自己维护签名/接口变更成本。
- **媒体下载（音频）**：yt-dlp（可用于下载音频供 ASR；注意遵守平台规则，仅用于个人学习研究）。
- **文本抽取**：
  - HTML 解析：selectolax 或 BeautifulSoup4
  - 文章正文抽取（可选）：readability-lxml

#### 2.3.7 ASR 转写（本地）
- **首选**：字幕优先（成本低、质量高）
- **ASR 兜底**：
  - Apple Silicon 本地：whisper.cpp（可选 CoreML 加速）
  - 通用方案：faster-whisper（对 CPU/GPU 友好）
- **要求**：输出必须包含时间戳，才能实现“引用回跳”。

#### 2.3.8 前端与交互（本地启动的“网站形态”）
- **推荐方案**：Next.js（React）+ TailwindCSS + shadcn/ui
  - Chat 体验更好，易实现引用卡片/右侧证据栏/报告页。
- **更轻量替代**：
  - FastAPI + Jinja2 模板（最快做出可用原型）
  - Streamlit/Gradio（适合快速验证，但“网站产品形态”可控性较弱）
- **流式输出**：
  - FastAPI 推荐用 SSE（EventSource）或 WebSocket，实现 token streaming 与“任务进度推送”。

#### 2.3.9 评测与回归
- **RAG 评测**：ragas（适合做检索/忠实度等指标的自动化评测）
- **回归测试**：pytest + 固定评测集（每次改 chunk/retrieval/prompt/model 都能对比）
- **可替换项**：deepeval / 自建 LLM-as-judge 脚本（注意固定评测版本与采样策略）

#### 2.3.10 本地启动方式（建议）
- **依赖服务**：建议用 Docker Compose 拉起 Postgres + Redis（最省事，跨平台一致）。
- **启动进程**：
  - API：`uvicorn` 启动 FastAPI
  - Worker：Celery worker
  - 前端：Next.js dev server（或打包后由 FastAPI 静态托管）
- **密钥管理**：硅基流动 API Key 放在 `.env`，不写入代码、不提交版本库。

### 2.4 API 设计（FastAPI）
本节定义对外 API（给前端/脚本调用），建议统一前缀为 `/api/v1`。个人工具默认不做复杂鉴权，但接口结构保持可扩展。

#### 2.4.1 通用约定
- **Base URL**：`/api/v1`
- **Content-Type**：`application/json; charset=utf-8`
- **ID 形式**：服务端生成 `uuid` 字符串（`author_id`/`content_id`/`segment_id`/`job_id`/`session_id` 等）。
- **时间字段**：统一使用 ISO8601（例如 `2026-01-17T13:00:00+08:00`）。
- **视频时间戳**：统一使用毫秒 `start_time_ms/end_time_ms`（前端展示时转 `hh:mm:ss`）。
- **分页**：优先使用 cursor 分页：
  - 请求：`limit`（默认 20，最大 200）+ `cursor`（可选）
  - 响应：`next_cursor`（可选）
- **错误结构**（示例）：
  - HTTP 状态码：400/404/409/422/500
  - Body：`{"error": {"code": "...", "message": "...", "details": {...}}}`

#### 2.4.2 平台与作者（Authors）
##### 2.4.2.1 获取平台列表
- **GET** `/platforms`
- **Response**：`[{"platform": "bilibili", "display_name": "B站"}]`

##### 2.4.2.2 解析作者输入（不入库）
- **POST** `/authors/resolve`
- **Request**：
  - `platform`：`bilibili | wechat_mp | webpage | ...`
  - `input`：作者名或主页 URL
- **Response**：
  - `resolved`：是否成功
  - `external_id`：平台侧作者 id（若可获取）
  - `homepage_url`：标准化 URL
  - `display_name`：标准化名称（若可获取）

##### 2.4.2.3 创建作者并触发导入/更新（入库 + 启动任务）
- **POST** `/authors/import`
- **Request**：
  - `platform`
  - `input`（建议主页 URL）
  - `mode`：`incremental | full_rebuild`（默认 incremental）
  - `asr_policy`：`caption_only | asr_if_missing | always`（默认 asr_if_missing）
  - `summarize_policy`：`on_ingest | lazy`（默认 on_ingest；大作者建议 lazy）
- **Response**：`{"author_id": "...", "job_id": "..."}`

##### 2.4.2.4 查询作者
- **GET** `/authors?platform=...&limit=...&cursor=...`
- **GET** `/authors/{author_id}`

##### 2.4.2.5 触发作者增量同步
- **POST** `/authors/{author_id}/sync`
- **Request**：`{"mode": "incremental"}`
- **Response**：`{"job_id": "..."}`

#### 2.4.3 内容（Contents）
##### 2.4.3.1 列出作者内容
- **GET** `/authors/{author_id}/contents?type=video|article&status=...&from=...&to=...&q=...&limit=...&cursor=...`
- **Response（示例结构）**：
  - `items`：`[{"content_id":"...","type":"video","title":"...","url":"...","published_at":"...","duration_ms":123000,"processing_status":"..."}]`
  - `next_cursor`

##### 2.4.3.2 获取内容详情与处理状态
- **GET** `/contents/{content_id}`

##### 2.4.3.3 触发单内容处理（可选）
- **POST** `/contents/{content_id}/process`
- **Request**：`{"steps": ["transcribe","segment","index","summarize"]}`
- **Response**：`{"job_id":"..."}`

##### 2.4.3.4 获取内容摘要
- **GET** `/contents/{content_id}/summaries?type=content|short`

#### 2.4.4 分段与证据（Segments/Citations）
##### 2.4.4.1 获取段落（用于“展开引用原文”）
- **GET** `/segments/{segment_id}`

##### 2.4.4.2 获取内容下的段落（调试用）
- **GET** `/contents/{content_id}/segments?limit=...&cursor=...`

#### 2.4.5 任务与进度（Jobs）
任务用于承载离线构建（采集/转写/摘要/报告）的异步执行。

##### 2.4.5.1 查询任务
- **GET** `/jobs?status=...&author_id=...&limit=...&cursor=...`
- **GET** `/jobs/{job_id}`

##### 2.4.5.2 取消任务（可选）
- **POST** `/jobs/{job_id}/cancel`

##### 2.4.5.3 任务进度推送（SSE，可选）
- **GET** `/jobs/{job_id}/events`
- **Response**：`text/event-stream`
- **事件建议**：
  - `event: progress`，`data: {"progress": 0.42, "stage": "transcribe", "message": "..."}`
  - `event: error`，`data: {"code": "...", "message": "..."}`
  - `event: done`，`data: {"status": "succeeded"}`

#### 2.4.6 报告（Reports）
##### 2.4.6.1 获取作者报告
- **GET** `/authors/{author_id}/report`
- **Response**：`{"report_version":"...","json_payload":{...},"created_at":"..."}`

##### 2.4.6.2 触发作者报告生成/刷新（可选）
- **POST** `/authors/{author_id}/report/generate`
- **Response**：`{"job_id":"..."}`

#### 2.4.7 在线问答（Chat/RAG）
Chat 需要支持：限定作者范围、可选过滤、可追溯引用、以及流式输出。

##### 2.4.7.1 非流式问答
- **POST** `/chat`
- **Request（示例）**：
  - `author_id`
  - `query`
  - `session_id`（可选，用于多轮）
  - `filters`（可选）：`{"from":"...","to":"...","content_types":["video"],"topics":["..."]}`
  - `retrieval`（可选）：`{"top_n_contents":20,"top_k_segments":8,"use_hybrid":true,"use_rerank":true}`
  - `debug`（可选）：是否返回检索详情
- **Response（示例结构）**：
  - `answer`：最终回答
  - `citations`：证据列表（用于 UI 展示与回跳）
  - `session_id`
  - `debug`（可选）

`citations` 建议字段：
- `segment_id`
- `content_id`
- `content_url`
- `external_content_id`（例如 BV）
- `start_time_ms`/`end_time_ms`
- `snippet`（展示用短片段）
- `score`（可选）
- `jump_url`（可选：已拼好的可点击链接，前端可直接用）

##### 2.4.7.2 流式问答（SSE）
- **POST** `/chat/stream`
- **Request**：同 `/chat`
- **Response**：`text/event-stream`
- **事件建议**：
  - `event: delta`，`data: {"text": "..."}`（模型 token 增量）
  - `event: citation`，`data: {"segment_id":"...", "jump_url":"...", "snippet":"..."}`（可在生成中途先吐引用）
  - `event: done`，`data: {"answer":"...","citations":[...]}`（最终聚合结果）
  - `event: error`，`data: {"code":"...","message":"..."}`

#### 2.4.8 检索调试（可选，但强烈建议）
用于排查“漏检/信噪比低/语义不匹配”等问题。
- **POST** `/retrieval/preview`
- **Request**：`{"author_id":"...","query":"...","top_n_contents":20,"top_k_segments":20}`
- **Response**：返回候选内容与段落列表（含 score、命中原因、rerank 前后排序）。

## 3. 数据模型与存储设计
### 3.1 核心实体（建议）
- **Author**：platform、external_id、name、homepage_url、avatar、created_at、updated_at
- **ContentItem**（视频/文章统一）：
  - author_id、platform、external_id、type(video/article)、title、url、published_at
  - duration（视频）、extra_json（分P/合集/标签/简介等）
- **TranscriptSource**：
  - content_id、source_type(caption/asr)、language、raw_path、status
- **Segment**（唯一真相来源）：
  - content_id、segment_index、start_time_ms、end_time_ms、text、tokens、sha1
  - prev_segment_id、next_segment_id
- **Summary**（分层）：
  - content_id、summary_type(content/short/segment_optional)、json_payload、model、prompt_version、created_at
- **AuthorReport**：
  - author_id、report_version、json_payload、created_at
- **Job/Task**：
  - job_type、target_id、status、progress、error、retry_count、locked_at

### 3.2 设计要点
- **可追溯引用**：每个 Segment 必须包含来源定位（视频时间戳/文章段落范围），回答输出引用直接回链到 Segment。
- **幂等键**：
  - content：platform+external_id
  - segment：content_id+sha1（文本归一化后 hash）
- **增量更新**：根据 content 的更新时间/字幕版本变化，决定是否重跑后续步骤。

## 4. 平台适配器（Source Adapter）
### 4.1 统一接口（概念）
每个平台实现以下能力：
- `resolve_author(input)`：输入 author_name 或 homepage_url → 返回 external_id 与标准化主页
- `list_contents(author)`：分页拉取内容列表（含 external_id、title、url、published_at 等）
- `fetch_content_detail(content)`：可选，补充分P、合集、标签、简介等
- `fetch_text_or_media(content)`：
  - 视频：获取字幕（如有）/下载音频（ASR 兜底）
  - 文章：获取正文文本与段落结构

### 4.2 扩展到公众号/网页
- 将“文章正文”直接进入 Segment/Index/Summary 流程，复用后端。
- 公众号/网页抓取存在限制时，优先支持“用户导入链接/导入导出文件”的方式。

## 5. 转写与分段（Chunking）
### 5.1 转写策略
- **字幕优先**：准确、便宜、速度快。
- **ASR 兜底**：无字幕或字幕质量低时，使用 ASR（需预算控制）。
- **保留时间戳**：无论字幕还是 ASR，必须保留对齐时间信息。

### 5.2 分段策略（解决切片死板/上下文丢失）
- **语义断句 + token 目标长度**：避免固定 N 秒/固定字符。
- **可控 overlap**：片段之间保留部分重叠。
- **邻接关系**：存 prev/next，支持检索后的邻近补全。

## 6. 摘要与报告生成
### 6.1 单内容结构化摘要（建议字段）
- 一句话主旨
- 3-7 条要点
- 论证结构（观点→论据→例子）
- 关键术语解释
- 可引用证据（segment_id 列表，或 BV+时间戳列表）
- 适合人群/前置知识

### 6.2 作者级报告（跨内容汇总）
- 主题聚类：按内容摘要/标题/embedding 聚类为主题簇
- 层级总结：Segment → Content → Cluster → Author
- 输出结构：
  - 核心命题（1-3）
  - 支撑论点（每条配证据）
  - 主题地图（主题簇）
  - 观点演化时间线（可选）
  - 冲突观点/争议点（可选，按时间/来源分别呈现）

## 7. 在线问答（RAG）设计
### 7.1 分层检索（降低噪声，提升可扩展）
- **Level-1：ContentItem 索引**
  - 文本：title + intro + content_summary
  - 目的：先确定“相关内容集合”（TopN 视频/文章）
- **Level-2：Segment 索引**
  - 文本：转写段落原文
  - 目的：找可引用证据

### 7.2 混合检索与重排（解决漏检/语义不匹配）
- **混合检索**：BM25（关键词）+ 向量（语义）
- **过滤**：限定 author_id、内容时间范围、type
- **重排（Rerank）**：对候选段落做相关性重排（显著提升命中质量）

### 7.3 上下文拼装（解决窗口限制/信噪比低）
- **邻近补全**：命中段落补齐前后段（基于 prev/next）
- **去重与多样性**：避免同一内容重复占据上下文
- **检索后压缩**：对候选证据做短摘要，但保留 segment_id 以便引用

### 7.4 生成与引用
- 输出必须附带引用：
  - 视频：BV + 时间戳（或直接 segment 的 start_time）
  - 文章：URL + 段落定位
- 若证据不足：明确提示并建议用户改写问题或缩小范围。

### 7.5 Grounding 自检（降低幻觉）
- 生成后进行一次“断言-证据”核对：
  - 不被证据支持的句子删除或降级措辞
  - 输出中标注“推测/可能”与“证据支持”区分

## 8. Agent 化设计（在 Serve 侧更有收益）
### 8.1 最小可用 Agent 组合
- **Orchestrator**：判断是否需要子问题拆解、多跳检索、是否需要反问澄清
- **Retriever Tool**：实现两级检索、重排、邻近补全、上下文压缩
- **Grounding Checker**：回答自检与引用一致性校验

### 8.2 多跳检索（跨文档逻辑）
- 将复杂问题拆为子问题：
  - 先检索“相关主题/视频集合”
  - 再下钻“具体证据段落”
  - 最后综合回答

## 9. 评测与迭代（从玄学到工程）
### 9.1 指标
- **检索指标**：Recall@K、MRR/nDCG
- **引用正确率**：引用片段是否真实存在、时间戳是否匹配
- **忠实度/幻觉率**：回答断言是否可被证据支持

### 9.2 数据集
- **自动合成**：从随机 segment 生成问题，segment 作为标准证据
- **小规模黄金集**：手工挑选 20-50 个高价值问题（跨文档、冲突、易幻觉）

### 9.3 回归机制
- 变更 chunk 策略/检索策略/prompt/model 后，跑固定评测集出报告对比。

## 10. 性能、成本与策略
- **渐进构建（Lazy ASR）**：
  - 先入库元信息与字幕（如有）
  - 对“检索命中/高价值内容”再做 ASR 与深度摘要
- **预算控制**：按作者/按日限制 ASR 时长与 LLM 调用次数
- **缓存**：embedding、摘要结果按 sha1/prompt_version 缓存

## 11. 安全与合规（个人工具版）
- 尊重平台与作者权益；不默认提供内容再分发功能。
- 对外分享时仅展示引用与短片段（可配置）。

## 12. 实施路线（建议）
- **阶段 A（MVP）**：B 站单作者 → 字幕/ASR → 分段入库 → Chat 引用回跳 → 单内容摘要
- **阶段 B**：作者报告、两级检索（混合检索+重排）、断点续跑与可观测
- **阶段 C**：渐进构建、冲突观点呈现、评测与回归
- **阶段 D**：公众号/网页适配器、多作者管理、模型与成本优化（必要时 LoRA 微调）
